<script src="/plugins/datatable/js/jquery.dataTables.min.js"></script>
<script src="/plugins/datatable/js/dataTables.bootstrap4.min.js"></script>
<link rel="stylesheet" href="/plugins/datatable/css/dataTables.bootstrap4.min.css">

<div class="row">
    <div class="col-12">
        <div class="card card-outline card-primary">
            <div class="card-header">
                <h3 class="card-title">{{app}}</h3>
            </div>
            <div class="card-body">
                <div class="col-lg-8 offset-lg-2">
                    <table class="table table-striped table-bordered table-hover" id="dataTable">
                        <thead>
                            <tr>
                                <!-- <th></th> -->
                                <th>User</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>

                        </tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>
</div>
<input type="hidden" id="_app_" value="{{app}}">
<script>
    $(function () {
        dataTable = $('#dataTable').DataTable();
        initData();
    })

    function initData() {
        let app = $('#_app_').val()
        getDetailData(app, function (data) {

            for (let i = 0; i < data.length; i++) {
                dataTable.row.add([
                    `<span class="user">${data[i]}</span>`,
                    renderButton(),
                ])
            }
            dataTable.draw();
        })
    }

    function getDetailData(app, callback) {
        $.ajax({
            url: "/admin/app/listuser",
            type: "POST",
            data: {
                app: app,
            },
            success: function (result) {
                callback(result);
            },
            error: function (msg) {
                console.log(msg);
            },
        })
    }

    function renderButton() {
        return `<button class='btn btn-danger remove'  data-loading-text="<i class='spinner-grow spinner-grow-sm '></i> Verifying...">Remove</button>`
    }

    $('#dataTable').on("click", ".remove", function () {
        let $this = $(this);
        let $row = $this.parents('tr');
        let username = $row.find(".user").text();
        let app = $('#_app_').val();
        $this.enableButtonLoading();
        removeUserFromApp(app, username, function (result) {
            console.log(result);
            if (result.code > 0 && result.app == app && result.username == username) {
                dataTable.row($row).remove().draw();
                sweetToastAlertSuccess(result.msg);
            }else {
                sweetToastAlertError(result.msg);
            }

            $this.resetButtonLoading();
        })
    })

    function removeUserFromApp(app, username, callback) {
        $.ajax({
            url: "/admin/app/listuser/remove",
            type: "POST",
            data: {
                app: app,
                username: username,
            },
            success: function (result) {
                callback(result);
            },
            error: function (msg) {
                console.log(msg);
            },
        })
    }
</script>